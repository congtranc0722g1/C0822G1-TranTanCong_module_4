<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
  <link rel="stylesheet" href="../../bootstrap-5.1.3-dist/css/bootstrap.css">
  <link rel="stylesheet" href="../../css/home.css">
  <link rel="stylesheet" href="../../css/contract.css">
</head>
<body>
<div class="insert" th:insert="~{/layout::header}"></div>
<div class="background-main">
  <div class="row text-danger text-center">
    <h1>QUẢN LÝ HỢP ĐỒNG</h1>
  </div>
  <div class="row main">
    <div class="col-lg-3">
      <a href="list.html">
        <button class="btn btn-warning btn-outline-danger">Làm mới trang</button>
      </a>
    </div>

    <div class="col-lg-3">
      <a href="../main_furama/furama.html">
        <button class="btn btn-warning btn-outline-danger">Quay lại trang chủ</button>
      </a>
    </div>

    <div class="col-lg-2">
        <button class="btn btn-outline-primary" role="button" data-bs-toggle="modal" data-bs-target="#exampleModal3">Thêm mới</button>
    </div>

<!--    <div class="col-lg-4">-->
<!--      <form class="d-flex">-->
<!--        <input class="form-control me-2 justify-content-between" type="text" placeholder="Nhập tên dịch vụ"-->
<!--               aria-label="Search" style="width: 150px" name="name">-->
<!--        <input class="form-control me-2 justify-content-between" type="text" placeholder="Nhập tên khách hàng"-->
<!--               aria-label="Search" style="width: 150px" name="address">-->
<!--        <input type="hidden" name="action" value="search">-->
<!--        <button class="btn btn-success btn-outline-warning" type="submit"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">-->
<!--          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>-->
<!--        </svg></button>-->
<!--      </form>-->
<!--    </div>-->
  </div>

  <p id="mess" class="text-center text-danger mt-2" th:text="${mess}"></p>

  <div class="row margin">
    <table class="table table-striped table-bordered" style="width: 100%">
      <thead>
      <tr class="align text-center">
        <th>STT</th>
        <th>Dịch Vụ</th>
        <th>Khách Hàng</th>
        <th>Ngày Bắt Đầu</th>
        <th>Ngày Kết Thúc</th>
        <th>Tiền Đặt Cọc</th>
        <th>Tổng Tiền</th>
        <th>Các Dịch Vụ Đi Kèm</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="contract, status : ${contractList}">
        <td th:text="${status.count}"></td>
        <td th:text="${contract.facility.name}"></td>
        <td th:text="${contract.customer.name}"></td>
<!--        <td th:text="${contract.startDay}"></td>-->
        <td th:text="${#temporals.format(contract.startDay, 'dd/MM/yyyy')}"></td>
<!--        <td th:text="${contract.endDay}"></td>-->
        <td th:text="${#temporals.format(contract.endDay, 'dd/MM/yyyy')}"></td>
        <td th:text="${contract.deposit}"></td>
        <td th:text="0đ"></td>
        <td>
          <button type="button" class="btn btn-primary"
                  th:attr="onclick=|infoContract('${contract.id}', '${contract.facility.name}');|" data-bs-toggle="modal"
                  data-bs-target="#exampleModal2">+
          </button>
          <button type="button" class="btn btn-primary"
                  th:attr="onclick=|search('${contract.id}');|" data-bs-toggle="modal"
                  data-bs-target="#exampleModal1">Danh sách dịch vụ đi kèm
          </button>
          </td>
      </tr>
      </tbody>
    </table>
    <div class="text-center mb-1">
      <a class="btn btn-secondary" th:href="@{/contract/(page=${contractList.number - 1})}" th:if="${contractList.hasPrevious()}">
        Trang trước
      </a>
      <span th:text="${contractList.number + 1 + '/' + contractList.totalPages}"></span>
      <a class="btn btn-primary" th:href="@{/contract/(page=${contractList.number + 1})}" th:if="${contractList.hasNext()}">
        Trang tiếp theo
      </a>
    </div>
  </div>
</div>

<!-- Danh sách dịch vụ đi kèm -->
<div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel1">Danh sách dịch vụ đi kèm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-striped table-bordered">
          <thead>
          <tr class="align text-center">
            <th>STT</th>
            <th>Tên Dịch Vụ Đi Kèm</th>
            <th>Giá</th>
            <th>Số Lượng</th>
            <th>Đơn Vị</th>
            <th>Trạng Thái</th>
          </tr>
          </thead>
          <tbody id="my-body"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
      </div>
    </div>
  </div>
</div>

<!-- Thêm mới hợp đồng-->
<div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel3">Thêm mới hợp đồng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/contract/add" method="post" th:object="${contractDto}">
      <div class="modal-body">
        <div class="mb-3">
          <label th:for="startDay" class="form-label">Ngày làm hợp đồng</label>
          <input th:field ="*{startDay}" type="date" class="form-control width-form">
        </div>
        <div class="mb-3">
          <label th:for="endDay" class="form-label">Ngày kết thúc</label>
          <input th:field ="*{endDay}"  type="date" class="form-control width-form">
        </div>
        <div class="mb-3">
          <label th:for="deposit" class="form-label">Tiền đặt cọc</label>
          <input th:field ="*{deposit}"  type="text" class="form-control width-form">
        </div>
        <div class="mb-3">
          <label th:for="customer" class="form-label">Khách hàng</label>
          <select th:field ="*{customer}" >
            <option th:each="customer : ${customerList}" th:value="${customer.id}" th:text="${customer.name}"></option>
          </select>
        </div>
        <div class="mb-3">
          <label th:for="employee" class="form-label">Nhân viên</label>
          <select th:field ="*{employee}" >
            <option th:each="employee : ${employeeList}" th:value="${employee.id}" th:text="${employee.name}"></option>
          </select>
        </div>
        <div class="mb-3">
          <label th:for="facility" class="form-label">Dịch vụ</label>
          <select th:field ="*{facility}" >
            <option th:each="facility : ${facilityList}" th:value="${facility.id}" th:text="${facility.name}"></option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="submit" class="btn btn-primary">Lưu</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!--Hợp đồng chi tiết-->
<div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel2">Hợp đồng chi tiết</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/contract/add-contract-detail" method="post" th:object="${contractDetail}">
      <div class="modal-body">
        <input th:field ="*{contract}" type="hidden" id="ContractId" class="form-control width-form">
        <div class="mb-3">
          <label class="form-label">Hợp đồng</label>
          <input readonly id="facilityName" type="text" class="form-control width-form">
        </div>
        <div class="mb-3">
          <label class="form-label">Dịch vụ đi kèm</label>
          <select th:field ="*{attachFacility}" class="select form-control-md">
            <option th:each="attachFacility : ${attachFacilityList}" th:value="${attachFacility.id}" th:text = "${attachFacility.name}"></option>
          </select>
        </div>
        <div class="mb-3">
          <label th:for="quantity" class="form-label">Số lượng</label>
          <input th:field ="*{quantity}" type="text" class="form-control width-form">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="submit" class="btn btn-primary">Lưu</button>
      </div>
      </form>
    </div>
  </div>
</div>
<div class="insert" th:insert="~{/layout::footer}"></div>
<script src="../../bootstrap-5.1.3-dist/js/bootstrap.js"></script>
<script>
  setTimeout(function(){ close(document.getElementById("mess").style.display= "none") }, 5000);
</script>
<script>
  function infoContract(id, name) {
    document.getElementById("ContractId").value = id;
    document.getElementById("facilityName").value = name;
  }
</script>
<script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
<script>
  function search(id) {
    $.ajax({
      type: "GET",
      url: "/attach-facility/search/" + id,
      success: function (data) {
        //data => đang ở dạng json
        let table = '';// lưu trữ table
        for (let i = 0; i < data.length; i++) {
          table +=
                  `
                        <tr>
                            <th scope="row">${i + 1}</th>

                        </tr>
                        `
        }
        $('#my-body').html(table)
      }
    });
  }
</script>
</body>
</html>